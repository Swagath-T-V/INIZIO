<%- include("../../views/partials/user/header.ejs") %>

    <style>
        .product-detail {
            background-color: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .detail-gallery {
            position: relative;
        }

        .zoom-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .zoom-image {
            transition: transform 0.5s ease;
        }

        .zoom-lens {
            position: absolute;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: crosshair;
            width: 300px;
            height: 300px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            background: rgba(255, 255, 255, 0.5);
        }

        .zoom-container:hover .zoom-lens {
            opacity: 1;
        }

        .product-image-slider {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            height: 400px;
        }

        .product-image-slider img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .thumbnail-item {
            width: 70px;
            height: 70px;
            border: 1px solid #eee;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .thumbnail-item:hover {
            border-color: #16a085;
        }

        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .title-detail {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .product-meta {
            margin-bottom: 20px;
        }

        .product-rate-cover {
            display: flex;
            align-items: center;
        }

        .product-rating {
            background: url('/assets/images/star-rating.png') repeat-x;
            height: 20px;
        }

        .current-price {
            font-size: 28px;
            font-weight: 700;
            color: #16a085;
        }

        .old-price {
            text-decoration: line-through;
            color: #999;
            font-size: 18px;
        }

        .save-price {
            color: #e74c3c;
            font-weight: 500;
        }

        .product_features li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .product_features i {
            color: #16a085;
            margin-right: 5px;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            height: 35px;
            width: 102px;
        }

        .quantity-button {
            width: 30px;
            height: 100%;
            background: #f7f7f7;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .quantity-button:hover {
            background: #e0e0e0;
        }

        .quantity-input {
            width: 40px;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 16px;
            padding: 0;
            background: #fff;
            outline: none;
        }

        .quantity-input::-webkit-inner-spin-button,
        .quantity-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .add-to-cart {
            background-color: #16a085;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .add-to-cart:hover {
            background-color: #138a72;
        }

        .add-to-cart.loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .buy-now {
            background-color: #040404;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .buy-now:hover {
            background-color: #c0392b;
        }

        .buy-now.loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .product-buttons {
            display: flex;
            margin-top: 10px;
        }

        .wishlist-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wishlist-btn:hover {
            background-color: #f8f8f8;
            border-color: #16a085;
        }

        .product-additional-info {
            margin-top: 25px;
            padding-top: 10px;
            padding-bottom: 25px;
            border-top: 1px solid #eee;
            font-size: 14px;
            color: #777;
        }

        .product-info-tags a {
            color: #16a085;
            text-decoration: none;
            margin-right: 5px;
        }

        .breadcrumb-wrap {
            padding: 15px 0;
            background-color: #f8f8f8;
            margin-bottom: 30px;
        }

        .breadcrumb {
            margin: 0;
            padding: 0;
            background: none;
        }

        .breadcrumb-item+.breadcrumb-item::before {
            content: ">";
            color: #777;
            padding: 0 8px;
        }

        .breadcrumb-item a {
            color: #16a085;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .breadcrumb-item a:hover {
            color: #138a72;
            text-decoration: underline;
        }

        .breadcrumb-item.active {
            color: #333;
            font-weight: 500;
        }

        .stock-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: 500;
        }

        .in-stock {
            background-color: #e6f3e6;
            color: #16a085;
        }

        .out-of-stock,
        .sold-out,
        .unavailable {
            background-color: #ffe6e6;
            color: #e74c3c;
        }

        .disabled-btn {
            background-color: #ccc !important;
            cursor: not-allowed;
            pointer-events: none;
        }

        .related-products-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }

        .related-products-header {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .related-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
        }

        .related-product-item {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            text-align: center;
            overflow: hidden;
        }

        .related-product-item:hover {
            border-color: #16a085;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .related-product-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 15px;
            display: block;
        }

        .related-product-name {
            font-size: 16px;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            text-decoration: none;
            display: block;
            line-height: 1.4;
        }

        .related-product-price {
            color: #16a085;
            font-weight: 600;
            font-size: 18px;
            display: inline-block;
        }

        .related-product-old-price {
            color: #999;
            font-size: 14px;
            text-decoration: line-through;
            margin-left: 8px;
            display: inline-block;
        }

        .product-specifications {
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .specifications-header {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .specifications-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .spec-item {
            display: flex;
            align-items: flex-start;
        }

        .spec-label {
            font-weight: 500;
            color: #555;
            min-width: 120px;
        }

        .spec-value {
            color: #333;
        }

        a {
            transition: .3s all ease;
            color: #000000;
        }

        .wishlist-btn {
            background-color: #ffffff;
            color: #e74c3c;
            border: 2px solid #e74c3c;
            border-radius: 4px;
            padding: 8px 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
            height: 40px;
            text-align: center;
            white-space: nowrap;
        }

        .wishlist-btn i {
            font-size: 16px;
            line-height: 1;
        }

        .wishlist-btn:hover:not(.disabled-btn) {
            background-color: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .wishlist-btn.loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .wishlist-btn.added {
            background-color: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        .product-offers-section {
        margin: 30px 0;
        padding: 20px;
        background-color: #fafafa;
        border-radius: 10px;
        border: 1px solid #eee;
    }
    
    .offers-section-header {
        font-size: 22px;
        color: #333;
        margin-bottom: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .offers-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
    }
    
    .offer-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        border: 1px solid #f0f0f0;
        display: flex;
        align-items: flex-start;
        transition: all 0.3s ease;
    }
    
    .offer-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
        border-color: #16a085;
    }
    
    .offer-icon {
        font-size: 20px;
        color: #16a085;
        margin-right: 15px;
        min-width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(22, 160, 133, 0.1);
        border-radius: 50%;
        padding: 20px;
    }
    
    .offer-content {
        flex: 1;
    }
    
    .offer-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .offer-description {
        font-size: 14px;
        color: #555;
        margin: 0;
    }
    
    .offer-code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        color: #e74c3c;
        border: 1px dashed #ccc;
    }
    
    /* Offer Icon Colors */
    .offer-card:nth-child(1) .offer-icon {
        color: #e74c3c;
        background-color: rgba(231, 76, 60, 0.1);
    }
    
    .offer-card:nth-child(2) .offer-icon {
        color: #f39c12;
        background-color: rgba(243, 156, 18, 0.1);
    }
    
    .offer-card:nth-child(3) .offer-icon {
        color: #3498db;
        background-color: rgba(52, 152, 219, 0.1);
    }
    
    .offer-card:nth-child(4) .offer-icon {
        color: #9b59b6;
        background-color: rgba(155, 89, 182, 0.1);
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
        .offers-container {
            grid-template-columns: 1fr;
        }
    }
    .offer-applied-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #1bb71c; /* Red background like the image */
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: 600;
        transform: rotate(10deg); /* Slight tilt like the image */
        z-index: 1;
    }

    .best-offer {
        position: relative;
    }
    .best-offer-applied {
        margin-bottom: 20px;
        background: linear-gradient(135deg, #e6f3e6 0%, #f0f9f0 100%);
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 8px;
        animation: fadeIn 0.5s ease-in-out;
        border-left: 4px solid #16a085;
    }

    .offer-badge {
        display: flex;
        align-items: center;
        background-color: #16a085;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        width: fit-content;
        transition: transform 0.2s ease;
    }

    .offer-badge:hover {
        transform: scale(1.05);
    }

    .offer-badge i {
        margin-right: 8px;
        font-size: 16px;
    }

    .offer-text {
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .savings-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .savings-text {
        color: #333;
        font-size: 15px;
        font-weight: 500;
    }

    .savings-amount {
        color: #e74c3c;
        font-size: 16px;
        font-weight: 700;
        background-color: rgba(231, 76, 60, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
    }

    /* Fade-in animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    </style>

    <div class="hero-wrap hero-bread" style="background-image: url('/homeImages/banner.avif');">
        <div class="container">
            <div class="row no-gutters slider-text align-items-center justify-content-center">
                <div class="col-md-9 ftco-animate text-center">
                    <p class="breadcrumbs"><span class="mr-2"><a href="/">Home</a></span> <span>DETAILS</span></p>
                    <h1 class="mb-0 bread">DETAILS</h1>
                </div>
            </div>
        </div>
    </div>

    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <%= product.name %>
                        </li>
                    </ol>
                </nav>
            </div>
        </div>

        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="product-detail">
                            <div class="row">
                                <!-- Product Image Section -->
                                <div class="col-md-6 col-sm-12">
                                    <div class="detail-gallery">
                                        <div class="product-image-slider zoom-container">
                                            <figure class="border-radius-10">
                                                <img src="/uploads/product-image/<%= product.Images[0] %>"
                                                    alt="<%= product.name %>" id="mainImage" class="zoom-image">
                                            </figure>
                                            <div class="zoom-lens"></div>
                                        </div>
                                        <div class="slider-nav-thumbnails mt-15">
                                            <div class="d-flex">
                                                <% for(let i=0; i<product.Images.length; i++) { %>
                                                    <div class="thumbnail-item mx-2">
                                                        <img src="/uploads/product-image/<%= product.Images[i] %>"
                                                            alt="<%= product.name %> thumbnail">
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Product Info Section -->
                                <div class="col-md-6 col-sm-12">
                                    <div class="detail-info">
                                        <h1 class="title-detail">
                                            <%= product.name %>
                                        </h1>

                                        <div class="product-meta d-flex align-items-center mb-15">
                                            <div class="brands">
                                                <span>Type: </span>
                                                <a href="#">
                                                    <%= product.subCategory.name %>
                                                </a>
                                            </div>
                                            <div class="product-rate-cover ml-auto">
                                                <div class="product-rate d-inline-block">
                                                    <div class="product-rating" style="width:90%"></div>
                                                </div>
                                                <div class="rating d-flex">
                                                    <p class="text-left mr-4">
                                                        <a href="#" class="mr-2">5.0</a>
                                                        <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                        <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                        <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                        <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                        <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="clearfix product-price-cover mb-20">
                                            <div class="product-price primary-color">
                                                <span class="current-price text-brand">₹ <%= discountedPrice.toFixed(2) %></span>
                                                <% if (bestOffer) { %>
                                                    <span class="old-price font-md ml-15">₹ <%= product.salePrice.toFixed(2) %></span>
                                                    <% const discountPercentage = Math.round((1 - discountedPrice / product.salePrice) * 100); %>
                                                    <% if (discountPercentage > 0) { %>
                                                        <span class="save-price font-md color3 ml-15">
                                                            <%= discountPercentage %>% OFF
                                                        </span>
                                                    <% } %>
                                                <% } else { %>
                                                    <span class="old-price font-md ml-15">₹ <%= product.regularPrice %></span>
                                                    <% const discountPercentage = Math.round((1 - product.salePrice / product.regularPrice) * 100); %>
                                                    <% if (discountPercentage > 0) { %>
                                                        <span class="save-price font-md color3 ml-15">
                                                            <%= discountPercentage %>% OFF
                                                        </span>
                                                    <% } %>
                                                <% } %>
                                            </div>
                                        </div>

                                        

                                        <% let stockStatus='in-stock' ;
                                            let stockMessage=`In Stock (${product.quantity} available)`;
                                            if (product.quantity <=0)  {
                                                stockStatus='out-of-stock' ;
                                                stockMessage='Out of Stock' ; 
                                            } else if (product.status==='sold-out' ) {
                                                stockStatus='sold-out' ; 
                                                stockMessage='Sold Out' ; 
                                            } else if(product.status==='unavailable' ) {
                                                stockStatus='unavailable' ;
                                                stockMessage='Currently Unavailable' ; 
                                            }
                                        %> 
                                            <div class="stock-status <%= stockStatus %>">
                                                <%= stockMessage %>
                                            </div>

                                            <!-- Best Offer Applied Section -->
                                            <% if (bestOffer) { %>
                                                <div class="best-offer-applied mt-15">
                                                    <div class="offer-badge">
                                                        <i class="fas fa-gift"></i>
                                                        <span class="offer-text">Best Offer Applied : <%= bestOffer.offerName %></span>
                                                    </div>
                                                    <div class="savings-info">
                                                        <span class="savings-text">You Save: </span>
                                                        <span class="savings-amount">₹ <%= (product.salePrice - discountedPrice).toFixed(2) %></span>
                                                    </div>
                                                </div>
                                            <% } %>

                                            <div class="short-desc mb-30">
                                                <p>
                                                    <%= product.description || "No description available." %>
                                                </p>
                                            </div>

                                            <!-- Product Specifications -->
                                            <div class="product-specifications">
                                                <h3 class="specifications-header">Product Specifications</h3>
                                                <div class="specifications-list">
                                                    <div class="spec-item">
                                                        <span class="spec-label">Brand:</span>
                                                        <span class="spec-value">
                                                            <%= product.brand || "Generic" %>
                                                        </span>
                                                    </div>
                                                    <div class="spec-item">
                                                        <span class="spec-label">Material:</span>
                                                        <span class="spec-value">
                                                            <%= product.material || "N/A" %>
                                                        </span>
                                                    </div>
                                                    <div class="spec-item">
                                                        <span class="spec-label">Dimensions:</span>
                                                        <span class="spec-value">
                                                            <%= product.dimensions || "N/A" %>
                                                        </span>
                                                    </div>
                                                    <div class="spec-item">
                                                        <span class="spec-label">Weight:</span>
                                                        <span class="spec-value">
                                                            <%= product.weight || "N/A" %>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>


                                            <div class="cart-action d-flex flex-column mt-30">
                                                <!-- <div class="quantity-selector d-flex align-items-center <%= stockStatus !== 'in-stock' ? 'disabled-btn' : '' %>">
                                          <button class="quantity-button decrease">-</button>
                                          <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="<%= product.quantity %>" <%= stockStatus !== 'in-stock' ? 'disabled' : '' %>>
                                          <button class="quantity-button increase">+</button>
                                        </div> -->
                                                <div
                                                    class="quantity-selector d-flex align-items-center <%= stockStatus !== 'in-stock' ? 'disabled-btn' : '' %>">
                                                    <button class="quantity-button decrease">-</button>
                                                    <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="<%= Math.min(10, product.quantity) %>" <%=stockStatus !=='in-stock' ? 'disabled' : '' %>>
                                                    <button class="quantity-button increase">+</button>
                                                </div>
                                                <div class="product-buttons">
                                                    <button type="button"
                                                        class="btn btn-primary add-to-cart <%= stockStatus !== 'in-stock' ? 'disabled-btn' : '' %>" data-product-id="<%= product._id %>" <%=stockStatus !=='in-stock' ? 'disabled' : '' %>>Add to Cart</button>
                                                    <!-- <button type="button" class="btn btn-danger buy-now <%= stockStatus !== 'in-stock' ? 'disabled-btn' : '' %>" data-product-id="<%= product._id %>" <%= stockStatus !== 'in-stock' ? 'disabled' : '' %>>Buy Now</button> -->
                                                    <button type="button" class="btn wishlist-btn <%= stockStatus !== 'in-stock' ? 'disabled-btn' : '' %>" data-product-id="<%= product._id %>" <%=stockStatus !=='in-stock' ? 'disabled' : '' %>>
                                                        <i class="fas fa-heart"></i> <a href="">Add to Wishlist</a>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="product-additional-info mt-30 pt-30 border-top">
                                                <div class="product-info-tags mt-10">
                                                    <span>Category: </span>
                                                    <a href="#">
                                                        <%= product.category.name || "N/A" %>
                                                    </a>
                                                </div>
                                            </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Offers Section -->
                            <div class="product-offers-section">
                                <h3 class="offers-section-header">
                                    <i class="fas fa-gift text-danger"></i> Available Offers
                                </h3>
                                <div class="offers-container">
                                    <% if (offers && offers.length > 0) { %>
                                        <% offers.forEach(offer => { %>
                                            <div class="offer-card <%= bestOffer && bestOffer._id.toString() === offer._id.toString() ? 'best-offer' : '' %>">
                                                <% if (bestOffer && bestOffer._id.toString() === offer._id.toString()) { %>
                                                    <div class="offer-applied-badge">
                                                        <span>Applied</span>
                                                    </div>
                                                <% } %>
                                                <div class="offer-icon">
                                                    <i class="fas fa-<%= offer.offerType === 'Category' ? 'tags' : offer.offerType === 'subCategory' ? 'percentage' : 'bolt' %>"></i>
                                                </div>
                                                <div class="offer-content">
                                                    <h4 class="offer-title">
                                                        <%= offer.offerName %>
                                                        <% if (offer.offerType === 'Category') { %>
                                                            - <%= product.category.name %>
                                                        <% } else if (offer.offerType === 'subCategory') { %>
                                                            - <%= product.subCategory.name %>
                                                        <% } else if (offer.offerType === 'Product') { %>
                                                            - <%= product.name %>
                                                        <% } %>
                                                    </h4>
                                                    <p class="offer-description">
                                                        <% if (offer.discountType === 'percentage') { %>
                                                            (<%= offer.discountAmount %>% OFF)
                                                        <% } else { %>
                                                            (Flat ₹<%= offer.discountAmount %> OFF)
                                                        <% } %>
                                                        <br>
                                                        Valid until <%= new Date(offer.validUpto).toLocaleDateString() %>
                                                    </p>
                                                </div>
                                            </div>
                                        <% }); %>
                                    <% } else { %>
                                        <div class="offer-card">
                                            <div class="offer-content">
                                                <p class="offer-description">No offers available for this product.</p>
                                            </div>
                                        </div>
                                    <% } %>
                                </div>
                            </div>

                            <!-- Related Products Section -->
                            <div class="related-products-section">
                                <h3 class="related-products-header">Related Products</h3>
                                <div class="related-products-grid">
                                    <% if (products && products.length> 0) { %>
                                        <% products.forEach((product)=> { %>
                                            <div class="related-product-item">
                                                <a href="/productDetails?id=<%= product._id %>">
                                                    <img src="/uploads/product-image/<%= product.Images[0] || '/default-image.jpg' %>"
                                                        alt="<%= product.name %>" class="related-product-image">
                                                    <div class="related-product-name">
                                                        <%= product.name %>
                                                    </div>
                                                    <div class="related-product-price">₹ <%= product.salePrice %>
                                                    </div>
                                                    <% if (product.regularPrice> product.salePrice) { %>
                                                        <span class="related-product-old-price">₹ <%=product.regularPrice %></span>
                                                    <% } %>
                                                </a>
                                            </div>
                                            <% }); %>
                                        <% } else { %>
                                            <p>No related products available.</p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const decreaseBtn = document.querySelector('.quantity-button.decrease');
            const increaseBtn = document.querySelector('.quantity-button.increase');
            const quantityInput = document.querySelector('.quantity-input');
            const addToCartBtn = document.querySelector('.add-to-cart');
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail-item img');
            const maxQuantity = parseInt(quantityInput.getAttribute('max'))
            const isStockAvailable = '<%= stockStatus === "in-stock" %>' === 'true';

            // Quantity Selector Logic
            if (isStockAvailable) {
                decreaseBtn.addEventListener('click', () => {
                    const value = Math.max(1, parseInt(quantityInput.value) - 1);
                    quantityInput.value = value;
                });

                increaseBtn.addEventListener('click', () => {
                    const value = parseInt(quantityInput.value) + 1;
                    if (value <= maxQuantity) {
                        quantityInput.value = value;
                    } else {
                        Swal.fire('Limit Reached', `You can only add up to ${maxQuantity} items of this product.`, 'warning');
                    }
                });

                quantityInput.addEventListener('input', () => {
                    let value = parseInt(quantityInput.value);
                    if (isNaN(value) || value < 1) value = 1;
                    if (value > maxQuantity) {
                        value = maxQuantity;
                        Swal.fire('Limit Reached', `You can only add up to ${maxQuantity} items of this product.`, 'warning');
                    }
                    quantityInput.value = value;
                });
            }

            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', () => {
                    if (addToCartBtn.classList.contains('disabled-btn')) return;

                    const productId = addToCartBtn.dataset.productId;
                    const quantity = parseInt(quantityInput.value);

                    if (quantity > maxQuantity) {
                        Swal.fire('Limit Exceeded', `You can only add up to ${maxQuantity} items of this product.`, 'error');
                        return;
                    }

                    addToCartBtn.classList.add('loading');
                    addToCartBtn.textContent = 'Adding...';

                    $.ajax({
                        url: '/cartAdd',
                        method: 'POST',
                        data: { productId, quantity },
                        dataType: 'json', 
                        success: (response) => {
                            addToCartBtn.classList.remove('loading');
                            addToCartBtn.textContent = 'Add to Cart';

                            if (response.success) {
                                Swal.fire('Success', response.message || 'Added to cart successfully!', 'success').then(() => {
                                    window.location.href = response.redirectUrl || '/cart';
                                });
                            } else {
                                if (response.redirectUrl) {
                                    window.location.href = response.redirectUrl; 
                                } else {
                                    Swal.fire('Error', response.message || 'Failed to add to cart.', 'error');
                                }
                            }
                        },
                        error: (xhr, status, error) => {
                            addToCartBtn.classList.remove('loading');
                            addToCartBtn.textContent = 'Add to Cart';
                            Swal.fire('Error', 'Failed to add to cart. Please try again.', 'error');
                            console.log('AJAX Error:', status, error);
                        }
                    });
                });
            }


            const wishlistBtn = document.querySelector('.wishlist-btn');

            if (wishlistBtn) {
                wishlistBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (wishlistBtn.classList.contains('disabled-btn')) return;

                    const productId = wishlistBtn.dataset.productId;
                    const isAdded = wishlistBtn.classList.contains('added');

                    wishlistBtn.classList.add('loading');
                    wishlistBtn.innerHTML = `<span>${isAdded ? 'Removing...' : 'Adding...'} <i class="fas fa-heart ml-1"></i></span>`;

                    $.ajax({
                        url: '/addWishlist',
                        method: 'POST',
                        data: { productId },
                        success: (response) => {
                            wishlistBtn.classList.remove('loading');
                            if (response.redirectUrl || !response.success) {
                                window.location.href = response.redirectUrl || '/login';
                                return;
                            } else if (response.added === true) {
                                wishlistBtn.classList.add('added');
                                wishlistBtn.innerHTML = '<span>Added <i class="fas fa-heart ml-1"></i></span>';
                                Swal.fire('Success', 'Added to wishlist!', 'success');
                            } else if (response.added === false) {
                                wishlistBtn.classList.remove('added');
                                wishlistBtn.innerHTML = '<span>Wishlist <i class="fas fa-heart ml-1"></i></span>';
                                Swal.fire('Success', 'Removed from wishlist!', 'success');
                            } else {
                                wishlistBtn.innerHTML = '<span>Wishlist <i class="fas fa-heart ml-1"></i></span>';
                                Swal.fire('Error', response.message || 'Failed to update wishlist', 'error');
                            }
                        },
                        error: () => {
                            wishlistBtn.classList.remove('loading');
                            wishlistBtn.innerHTML = `<span>${isAdded ? 'Added' : 'Wishlist'} <i class="fas fa-heart ml-1"></i></span>`;
                            Swal.fire('Error', 'Failed to update wishlist. Try again.', 'error');
                        },
                    });
                });

                // Check initial wishlist state
                const productId = wishlistBtn.dataset.productId;
                $.ajax({
                    url: '/checkWishlist',
                    method: 'GET',
                    data: { productId },
                    success: (response) => {
                        if (response.inWishlist) {
                            wishlistBtn.classList.add('added');
                            wishlistBtn.innerHTML = '<span>Added <i class="fas fa-heart ml-1"></i></span>';
                        } else {
                            wishlistBtn.innerHTML = '<span>Wishlist <i class="fas fa-heart ml-1"></i></span>';
                        }
                    },
                    error: () => {
                        wishlistBtn.innerHTML = '<span>Wishlist <i class="fas fa-heart ml-1"></i></span>';
                    },
                });



            }

            // Zoom Functionality (Simplified)
            document.querySelectorAll('.zoom-container').forEach(container => {
                const img = container.querySelector('.zoom-image');
                const lens = container.querySelector('.zoom-lens');

                container.addEventListener('mousemove', (e) => {
                    const rect = container.getBoundingClientRect();
                    const posX = e.clientX - rect.left - lens.offsetWidth / 2;
                    const posY = e.clientY - rect.top - lens.offsetHeight / 2;
                    const maxX = rect.width - lens.offsetWidth;
                    const maxY = rect.height - lens.offsetHeight;
                    lens.style.left = `${Math.max(0, Math.min(posX, maxX))}px`;
                    lens.style.top = `${Math.max(0, Math.min(posY, maxY))}px`;
                    lens.style.background = `url(${img.src}) no-repeat ${-posX * 2}px ${-posY * 2}px / ${img.width * 2}px ${img.height * 2}px`;
                });

                container.addEventListener('mouseenter', () => lens.style.opacity = '1');
                container.addEventListener('mouseleave', () => lens.style.opacity = '0');
            });

            // Thumbnail Click Logic
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('click', () => mainImage.src = thumbnail.src);
            });

        });
    </script>


<%- include("../../views/partials/user/footer.ejs") %>